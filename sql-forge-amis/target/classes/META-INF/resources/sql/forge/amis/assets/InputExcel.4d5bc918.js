import{a as W,R as h,a7 as P,ao as M,aG as j,c1 as U,ae as N,ca as V,g as F,h as C,d as S,bh as X,W as D,cb as R,T,I as k,e as b,m as I,n as g,F as J,aS as w,aE as L,ak as z,cc as G,_ as O,V as H}from"./index.cf5795ed.js";var Z=function(x){W(d,x);function d(){var r=x!==null&&x.apply(this,arguments)||this;return r.state={files:[]},r.dropzone=h.createRef(),r}return d.prototype.componentDidUpdate=function(r){r.value!==this.props.value&&!this.props.value&&this.setState({files:[]}),r.value!==this.props.value&&this.props.value&&this.triggerAutoFill()},d.prototype.syncAutoFill=function(r,i){var n=this.props,t=n.autoFill,s=n.onBulkChange,u=n.data,e=n.name,c=n.multiple;if(!((t==null?void 0:t.hasOwnProperty("api"))||!P(t))){var l=e?M(t,e):t;if(!j(l)&&s){var p=void 0;if(c===!0){var a=this.state.files.filter(function(o){return o.state==="parsed"}).map(function(o){return{filename:o.name,data:o.data}});p={items:a,currentFile:{filename:r,data:i}}}else p={filename:r};var f=U(l,p);Object.keys(f).forEach(function(o){N(f[o])&&N(u[o])&&(f[o]=V({},u[o],f[o]))}),s(f)}}},d.prototype.handleDrop=function(r){return F(this,void 0,void 0,function(){var i,n,t,s,u,e,c=this;return C(this,function(l){return i=this.props,n=i.maxLength,t=i.multiple,r.length?t?(u=n?n-this.state.files.length:r.length,u<=0?[2]:(e=r.slice(0,u).map(function(p){return{file:p,id:w()}}),this.setState(function(p){return{files:L(L([],z(p.files),!1),z(e.map(function(a){var f=a.file,o=a.id;return{id:o,name:f.name,state:"pending"}})),!1)}},function(){c.processFiles(e)}),[2])):(s=[{file:r[0],id:w()}],this.setState({files:s.map(function(p){var a=p.file,f=p.id;return{id:f,name:a.name,state:"pending"}})},function(){c.processFiles(s)}),[2]):[2]})})},d.prototype.processFiles=function(r){return F(this,void 0,void 0,function(){var i,n=this;return C(this,function(t){switch(t.label){case 0:return i=r.map(function(s){var u=s.file,e=s.id,c=n.state.files.find(function(l){return l.id===e&&l.state==="pending"});return c?{file:u,fileState:c}:null}).filter(function(s){return s!==null}),i.length?[4,Promise.all(i.map(function(s){var u=s.file,e=s.fileState;return n.processExcelFile(u,e)}))]:[3,2];case 1:return t.sent(),[3,3];case 2:this.updateFormValue(),t.label=3;case 3:return[2]}})})},d.prototype.handleSelect=function(){var r=this.props,i=r.disabled,n=r.maxLength,t=r.multiple,s=t===!0||this.state.files.length===0;!i&&!(n&&this.state.files.length>=n)&&s&&this.dropzone.current&&this.dropzone.current.open()},d.prototype.removeFile=function(r){var i=this;this.setState(function(n){return{files:n.files.filter(function(t){return t.id!==r.id})}},function(){var n=i.state.files.filter(function(t){return t.state==="pending"});n.length===0&&i.updateFormValue()})},d.prototype.updateFileState=function(r,i){var n=this;this.setState(function(t){return{files:t.files.map(function(s){return s.id===r?S(S({},s),i):s})}},function(){if(i.state==="parsed"){var t=n.state.files.filter(function(s){return s.state==="pending"});t.length===0&&n.updateFormValue()}})},d.prototype.updateFormValue=function(){return F(this,void 0,void 0,function(){var r,i,n,t,s,u,e,c,l;return C(this,function(p){switch(p.label){case 0:return r=this.props,i=r.data,n=r.multiple,t=r.allSheets,s=r.parseImage,u=this.state.files.filter(function(a){return a.state==="parsed"}),u.length!==0?[3,2]:[4,this.dispatchEvent("change")];case 1:return p.sent(),this.props.onChange(void 0),[2];case 2:return n===!0?e=u.map(function(a){var f=Array.isArray(a.data)?a.data:[a.data];return{fileName:a.name,data:f.map(function(o){var v={sheetName:o.sheetName||"Sheet1",data:o.data||o};return s&&o.images&&(v.images=o.images),v})}}):(c=u[0],t?e=Array.isArray(c.data)?c.data:[c.data]:e=c.data),e&&G(e)&&(e=D(i,e)),[4,this.dispatchEvent("change",e)];case 3:return l=p.sent(),l!=null&&l.prevented?[2]:(this.props.onChange(e),this.triggerAutoFill(),[2])}})})},d.prototype.triggerAutoFill=function(){var r=this.props.autoFill;if(r&&!r.hasOwnProperty("api")&&P(r)){var i=this.state.files.filter(function(t){return t.state==="parsed"});if(i.length>0){var n=i[i.length-1];this.syncAutoFill(n.name,n.data)}}},d.prototype.processExcelFile=function(r,i){return F(this,void 0,void 0,function(){var n,t,s,u,e,c,l,p;return C(this,function(a){switch(a.label){case 0:n=this.props.translate,a.label=1;case 1:return a.trys.push([1,7,,8]),[4,new Promise(function(f,o){var v=new FileReader;v.onload=function(){v.result?f(v.result):o(new Error("Failed to read file"))},v.onerror=function(){return o(v.error)},v.readAsArrayBuffer(r)})];case 2:return t=a.sent(),s=r.name.toLowerCase().endsWith(".xls"),u=void 0,s?[4,O(()=>import("./xlsx.89ea120e.js"),[])]:[3,4];case 3:return e=a.sent(),c=e.read(new Uint8Array(t),{cellDates:!0}),l=e.writeXLSX(c,{type:"array"}),u=l.buffer,[3,5];case 4:u=t,a.label=5;case 5:return[4,this.parseExcelData(u,i)];case 6:return a.sent(),[3,8];case 7:return p=a.sent(),console.error("Excel parsing error:",p),this.updateFileState(i.id,{state:"error",error:p.message||n("Excel.parseError")}),[3,8];case 8:return[2]}})})},d.prototype.parseExcelData=function(r,i){return F(this,void 0,void 0,function(){var n,t,s,u,e,c,l,p,a,f,o;return C(this,function(v){switch(v.label){case 0:n=this.props,t=n.allSheets,s=n.parseImage,u=n.plainText,e=n.translate,v.label=1;case 1:return v.trys.push([1,4,,5]),[4,O(()=>import("./exceljs.min.42a3247b.js").then(function(m){return m.e}),["assets/exceljs.min.42a3247b.js","assets/index.cf5795ed.js","assets/index.080e6cda.css"])];case 2:return c=v.sent().default,this.ExcelJS=c,l=new c.Workbook,p=typeof r=="string"?new Uint8Array(r.split("").map(function(m){return m.charCodeAt(0)})).buffer:r,[4,l.xlsx.load(p)];case 3:return v.sent(),a=void 0,t?a=this.parseAllSheets(l,s,u):(f=l.worksheets.find(function(m){return m.state!=="hidden"}),a=s?{data:this.readWorksheet(f,u),images:this.readImages(f,l)}:this.readWorksheet(f,u)),this.updateFileState(i.id,{state:"parsed",data:a}),[3,5];case 4:return o=v.sent(),console.error("Excel parsing error:",o),this.updateFileState(i.id,{state:"error",error:o.message||e("Excel.parseError")}),[3,5];case 5:return[2]}})})},d.prototype.parseAllSheets=function(r,i,n){var t=this;i===void 0&&(i=!1),n===void 0&&(n=!0);var s=[];return r.eachSheet(function(u){var e=u.state||"visible";if(e!=="hidden"){var c={sheetName:u.name,data:t.readWorksheet(u,n)};i&&(c.images=t.readImages(u,r)),s.push(c)}}),s},d.prototype.readImages=function(r,i){var n,t,s=this.props.imageDataURI,u=r.getImages(),e=[];try{for(var c=X(u),l=c.next();!l.done;l=c.next()){var p=l.value,a=i.getImage(+p.imageId),f=this.encodeBase64Bytes(a.buffer);if(s){var o=a.extension||"png";e.push("data:image/".concat(o,";base64,")+f)}else e.push(f)}}catch(v){n={error:v}}finally{try{l&&!l.done&&(t=c.return)&&t.call(c)}finally{if(n)throw n.error}}return e},d.prototype.encodeBase64Bytes=function(r){return btoa(r.reduce(function(i,n){return i+String.fromCharCode(n)},""))},d.prototype.dispatchEvent=function(r,i){return F(this,void 0,void 0,function(){var n;return C(this,function(t){switch(t.label){case 0:return n=this.props.dispatchEvent,[4,n(r,H(this.props,{value:i}))];case 1:return[2,t.sent()]}})})},d.prototype.isRichTextValue=function(r){return!!(r&&P(r)&&r.hasOwnProperty("richText")&&Array.isArray(r==null?void 0:r.richText))},d.prototype.richText2PlainString=function(r,i){i===void 0&&(i=!1);var n=r.richText.map(function(t){var s=t.text,u=t.font,e=u===void 0?{}:u,c=s;if(i){var l="",p=e!=null&&e.bold?"strong":e!=null&&e.italic?"em":(e==null?void 0:e.vertAlign)==="superscript"?"sup":(e==null?void 0:e.vertAlign)==="subscript"?"sub":"span";e!=null&&e.strike?l+="text-decoration: line-through;":e!=null&&e.underline&&(l+="text-decoration: underline;"),e!=null&&e.outline&&(l+="outline: solid;"),e!=null&&e.size&&(l+="font-size: ".concat(e.size,"px;")),c="<".concat(p," ").concat(l?"style=".concat(l):"",">").concat(s,"</").concat(p,">")}return c});return n.join("")},d.prototype.readWorksheet=function(r,i){var n=this;i===void 0&&(i=!0);var t=[],s=this.props,u=s.parseMode,e=s.includeEmpty;if(u==="array")return r.eachRow(function(l){var p=l.values;p.shift(),i&&(p=p.map(function(a){if(a instanceof Object){if(a.hyperlink)return a.hyperlink.startsWith("mailto:")?a.hyperlink.substring(7):a.hyperlink;if(a.result)return a.result;if(a.richText)return n.richText2PlainString(a)}return a})),t.push(p)}),t;var c=[];return r.eachRow(function(l,p){var a;if(p==1)c=((a=l.values)!==null&&a!==void 0?a:[]).map(function(o){return n.isRichTextValue(o)?n.richText2PlainString(o):o});else{var f={};e&&c.forEach(function(o){f[o]=""}),l.eachCell(function(o,v){if(c[v]){var m=o.value;if(i){var y=n.ExcelJS.ValueType;o.type===y.Hyperlink?(m=o.value.hyperlink,m.startsWith("mailto:")&&(m=m.substring(7))):o.type===y.Formula?m=o.value.result:o.type===y.RichText?m=n.richText2PlainString(o.value):o.type===y.Error&&(m="")}f[c[v]]=m}}),t.push(f)}}),t},d.prototype.doAction=function(r,i,n){var t,s,u=r==null?void 0:r.actionType,e=this.props,c=e.onChange,l=e.resetValue,p=e.formStore,a=e.store,f=e.name;if(u==="clear")c("");else if(u==="reset"){var o=(s=D((t=p==null?void 0:p.pristine)!==null&&t!==void 0?t:a==null?void 0:a.pristine,f))!==null&&s!==void 0?s:l;c(o!=null?o:"")}},d.prototype.render=function(){var r=this,i=this.props,n=i.className,t=i.classnames,s=i.maxLength,u=i.disabled,e=i.translate,c=i.placeholder,l=i.testIdBuilder,p=i.multiple,a=i.env,f=i.container,o=this.state.files,v=!!s&&o.length>=s;return p!==!0?h.createElement("div",{className:t("ExcelControl",n)},h.createElement(R,{key:"drop-zone",ref:this.dropzone,onDrop:this.handleDrop,accept:".xlsx,.xls",multiple:!1,disabled:u},function(m){var y=m.getRootProps,A=m.getInputProps;return h.createElement("section",{className:t("ExcelControl-container",n)},h.createElement("div",S({},y({className:t("ExcelControl-dropzone")}),l==null?void 0:l.getTestId()),h.createElement("input",S({},A(),l==null?void 0:l.getChild("input").getTestId())),o.length>0&&o[0].state==="parsed"?h.createElement("p",null,e("Excel.parsed",{filename:o[0].name})):h.createElement("p",null,c!=null?c:e("Excel.placeholder"))))})):h.createElement("div",{className:t("ExcelControl",n)},h.createElement(R,{key:"drop-zone",ref:this.dropzone,onDrop:this.handleDrop,accept:".xlsx,.xls",multiple:!!p,disabled:u||v,noClick:!0},function(m){var y=m.getRootProps,A=m.getInputProps,_=m.isDragActive;return h.createElement("div",S({},y({className:t("ExcelControl-container",n)})),h.createElement(T,{placement:"top",container:f||(a==null?void 0:a.getModalContainer),tooltip:s===1?e("Excel.singleFile"):s?e("File.maxLength",{maxLength:s,uploaded:o.length}):"",tooltipClassName:t("ExcelControl-tooltip")},h.createElement("div",{className:t("ExcelControl-dropzone",{"is-disabled":u||v,"is-empty":!o.length,"is-active":_}),onClick:u||v?void 0:r.handleSelect},h.createElement("input",S({},A(),l==null?void 0:l.getChild("input").getTestId())),_?h.createElement("div",{className:t("ExcelControl-acceptTip")},h.createElement("p",null,e("File.dragDrop"))):h.createElement("div",{className:t("ExcelControl-acceptTip")},h.createElement("p",null,c!=null?c:e("Excel.placeholder"))))),o.length>0&&h.createElement("ul",{className:t("ExcelControl-list")},o.map(function(E){return h.createElement("li",{key:E.id},h.createElement(T,{placement:"top",container:f||(a==null?void 0:a.getModalContainer),tooltipClassName:t("ExcelControl-list-tooltip",E.state==="error"&&"is-invalid"),tooltip:E.state==="error"?E.error:E.name},h.createElement("div",{className:t("ExcelControl-itemInfo",{"is-invalid":E.state==="error"})},h.createElement("span",{className:t("ExcelControl-itemInfoIcon")},h.createElement(k,{icon:"file-excel",className:"icon"})),h.createElement("span",{className:t("ExcelControl-itemInfoText")},E.name),!u&&h.createElement("a",{"data-tooltip":e("Select.clear"),"data-position":"left",className:t("ExcelControl-clear"),onClick:function(B){B.stopPropagation(),r.removeFile(E)}},h.createElement(k,{icon:"close",className:"icon"})))),E.state==="pending"&&h.createElement("div",{className:t("ExcelControl-progressInfo")},h.createElement("p",null,e("Excel.parsing"))))})))}))},d.defaultProps={allSheets:!1,parseMode:"object",includeEmpty:!0,plainText:!0,parseImage:!1,imageDataURI:!0},b([I,g("design:type",Function),g("design:paramtypes",[String,Object]),g("design:returntype",void 0)],d.prototype,"syncAutoFill",null),b([I,g("design:type",Function),g("design:paramtypes",[Array]),g("design:returntype",Promise)],d.prototype,"handleDrop",null),b([I,g("design:type",Function),g("design:paramtypes",[]),g("design:returntype",void 0)],d.prototype,"handleSelect",null),b([I,g("design:type",Function),g("design:paramtypes",[Object]),g("design:returntype",void 0)],d.prototype,"removeFile",null),b([I,g("design:type",Function),g("design:paramtypes",[]),g("design:returntype",Promise)],d.prototype,"updateFormValue",null),d}(h.PureComponent),q=function(x){W(d,x);function d(){return x!==null&&x.apply(this,arguments)||this}return d=b([J({type:"input-excel"})],d),d}(Z);export{q as ExcelControlRenderer,Z as default};
